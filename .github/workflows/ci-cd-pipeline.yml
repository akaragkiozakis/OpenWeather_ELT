name: ğŸ§ª Data Quality & Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

env:
  PYTHON_VERSION: '3.10'
  
jobs:
  # ==========================================
  # JOB 1: Code Quality & Linting
  # ==========================================
  code-quality:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: ğŸ¨ Code Formatting Check (Black)
      run: |
        black --check --diff .
        
    - name: ğŸ“‹ Import Sorting Check (isort)
      run: |
        isort --check-only --diff .
        
    - name: ğŸ” Linting (flake8)
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
        
    - name: ğŸ”¬ Type Checking (mypy)
      run: |
        mypy --ignore-missing-imports src/ || true

  # ==========================================  
  # JOB 2: Data Quality Tests
  # ==========================================
  data-quality-tests:
    name: ğŸ§ª Data Quality Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        test-suite: ['bronze', 'silver', 'all']
        
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python  
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ§ª Run Bronze Layer Tests
      if: matrix.test-suite == 'bronze' || matrix.test-suite == 'all'
      run: |
        cd data_quality_tests
        python test_bronze_simple.py
        
    - name: ğŸ§ª Run Silver Layer Tests  
      if: matrix.test-suite == 'silver' || matrix.test-suite == 'all'
      run: |
        cd data_quality_tests
        python test_silver_local.py
        
    - name: ğŸ§ª Run All Tests
      if: matrix.test-suite == 'all'
      run: |
        cd data_quality_tests
        python run_all_tests.py
        
    - name: ğŸ“Š Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.test-suite }}
        path: |
          data_quality_tests/*.log
          data_quality_tests/test_results/

  # ==========================================
  # JOB 3: Security Scan
  # ==========================================
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”’ Run Safety Check
      run: |
        pip install safety
        safety check --json || true
        
    - name: ğŸ” Run Bandit Security Scan
      run: |
        pip install bandit
        bandit -r src/ databricks/ data_quality_tests/ -f json || true

  # ==========================================
  # JOB 4: Documentation Check
  # ==========================================
  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“– Check README Links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/mlc_config.json'
        
    - name: ğŸ“ Check Documentation Completeness
      run: |
        # Check if key documentation files exist
        test -f README.md || (echo "âŒ README.md missing" && exit 1)
        test -f data_quality_tests/README.md || (echo "âŒ Data quality README missing" && exit 1)
        test -f .gitignore || (echo "âŒ .gitignore missing" && exit 1)
        echo "âœ… All required documentation files present"

  # ==========================================
  # JOB 5: Build & Package Validation  
  # ==========================================
  build-validation:
    name: ğŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    needs: [code-quality, data-quality-tests]
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ—ï¸ Validate Project Structure
      run: |
        # Check critical directories exist
        test -d src/ || (echo "âŒ src/ directory missing" && exit 1)
        test -d databricks/ || (echo "âŒ databricks/ directory missing" && exit 1)
        test -d data_quality_tests/ || (echo "âŒ data_quality_tests/ directory missing" && exit 1)
        test -d great_expectations/ || (echo "âŒ great_expectations/ directory missing" && exit 1)
        echo "âœ… Project structure validated"
        
    - name: ğŸ§ª Import Test (Smoke Test)
      run: |
        # Test that main modules can be imported
        cd data_quality_tests
        python -c "import great_expectations; print('âœ… Great Expectations import successful')"
        python -c "import pandas; print('âœ… Pandas import successful')"
        echo "âœ… All critical imports successful"

  # ==========================================
  # JOB 6: Deployment Readiness
  # ==========================================
  deployment-readiness:
    name: ğŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [data-quality-tests, security-scan, documentation, build-validation]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: âœ… Deployment Pre-checks
      run: |
        echo "ğŸ¯ Running deployment readiness checks..."
        
        # Check version/release readiness
        if [ -f VERSION ]; then
          echo "ğŸ“‹ Version: $(cat VERSION)"
        fi
        
        # Validate configuration files
        test -f great_expectations/great_expectations.yml || (echo "âŒ GE config missing" && exit 1)
        
        echo "âœ… All deployment checks passed!"
        echo "ğŸš€ Project is ready for deployment!"
        
    - name: ğŸ“Š Generate Deployment Summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code quality checks passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Data quality tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security scan completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Documentation validated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build validation successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Project is ready for production deployment! ğŸ‰**" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # JOB 7: Notifications
  # ==========================================
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [deployment-readiness]
    if: always()
    
    steps:
    - name: ğŸ“¨ Build Status Notification
      run: |
        if [ "${{ needs.deployment-readiness.result }}" == "success" ]; then
          echo "âœ… Pipeline completed successfully!"
          echo "ğŸ‰ All quality gates passed - ready for deployment!"
        else
          echo "âŒ Pipeline failed - check logs for details"
          echo "ğŸ” Review failed jobs and fix issues before deployment"
        fi